name: Security - Secret Scanning

on:
  workflow_call:

permissions:
  contents: read
  security-events: write # SARIF upload

jobs:
  gitleaks:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          fetch-depth: 0 # Full history scan

      - name: Install Gitleaks
        run: |
          curl -sSfL https://github.com/gitleaks/gitleaks/releases/download/v8.24.3/gitleaks_8.24.3_linux_x64.tar.gz -o gitleaks.tar.gz
          tar -xzf gitleaks.tar.gz gitleaks
          chmod +x gitleaks
          ./gitleaks version

      - name: Run Gitleaks
        id: gitleaks
        continue-on-error: true # Findings don't block CI
        run: |
          ./gitleaks detect --source . --report-format sarif --report-path results.sarif --verbose

      - name: Upload SARIF report
        if: always() && hashFiles('results.sarif') != ''
        uses: github/codeql-action/upload-sarif@b5ebac6f4c00c8ccddb7cdcd45fdb248329f808a # v3
        with:
          sarif_file: results.sarif
